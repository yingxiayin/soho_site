const fs = require('fs')
const path = require('path')

// Read meta JSON file (content stored in separate markdown files)
const metaFilePath = path.join(__dirname, '..', 'data', 'blog-posts-meta.json')
const blogPostsMeta = JSON.parse(fs.readFileSync(metaFilePath, 'utf-8'))

function readContentFile(contentPath) {
  const fullPath = path.join(__dirname, '..', 'data', contentPath)
  return fs.readFileSync(fullPath, 'utf-8')
}

// Build combined posts data (meta + content string)
const blogPostsData = Object.fromEntries(
  Object.keys(blogPostsMeta).map((key) => {
    const meta = blogPostsMeta[key]
    const content = readContentFile(meta.contentPath)
    const { contentPath, ...rest } = meta
    return [key, { ...rest, content }]
  })
)

// Generate TypeScript file
const tsFilePath = path.join(__dirname, '..', 'data', 'blog-posts-data.ts')

// Convert JSON to TypeScript with numeric keys
let tsContent = `// This file is auto-generated from blog-posts-meta.json and data/blog-posts/*.md
// Do not edit this file directly. Edit blog-posts-meta.json and the markdown files instead.

export const blogPostsData = {
`

// Write each blog post with numeric key
Object.keys(blogPostsData).sort((a, b) => parseInt(a) - parseInt(b)).forEach(key => {
  const post = blogPostsData[key]
  const postJson = JSON.stringify(post, null, 2)
  // Indent each line
  const indented = postJson.split('\n').map((line, index) => {
    if (index === 0) return `  ${key}: ${line}`
    return `  ${line}`
  }).join('\n')
  tsContent += indented + ',\n'
})

tsContent += `}
`

fs.writeFileSync(tsFilePath, tsContent, 'utf-8')

console.log(`âœ… Generated blog-posts-data.ts with ${Object.keys(blogPostsData).length} blog posts`)
